import{c as l,a,d as h,w,r as g,t as m,b as u,F as _,h as k,i as v,E as V,n as I,m as C,j as f,o as c,f as H}from"./app-DB903dGk.js";import{m as W,p as U}from"./purify.es-DFKIZymj.js";import{I as q}from"./Input-BL7OSBt_.js";import{B as K}from"./Button-MYDuztI5.js";import{a as P,D as E}from"./dateUtils-CA0ranRn.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{c as B}from"./createLucideIcon-DIXLg_3g.js";import{P as S}from"./plus-xzKPLU_4.js";import{C as G}from"./circle-alert-CEfAiM3V.js";import{A as J}from"./arrow-up-B1IjiNg6.js";import{A as L}from"./arrow-left-DptR83lI.js";import{B as Q}from"./bot-C_N1pDzA.js";import{L as R}from"./loader-DeCjsEU3.js";import"./Tooltip-CiqB0ikv.js";import"./mail-BQRDUCKB.js";/**
 * @license lucide-vue-next v0.488.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=B("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-vue-next v0.488.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=B("trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]),Y={inject:["notificationState"],components:{Input:q,Button:K,Dropdown:E,Loader:R,BotIcon:Q,ArrowLeft:L,ArrowUp:J,AlertCircle:G,Send:X,Plus:S,Trash:z},data(){return{Plus:S,Trash:z,ArrowLeft:L,threads:[],messages:[],copilot:null,newMessage:"",currentThread:null,expandedContext:{},isLoadingThread:!1,isLoadingCopilot:!1,isSendingMessage:!1,isLoadingMessages:!1,isNewConversation:!1}},watch:{$route(s,t){s.name==="create-copilot-conversation-thread"&&(this.messages=[],this.newMessage="",this.currentThread=null,this.expandedContext={},this.isNewConversation=!0,this.conversationThreadId=null,this.fetchThreads())}},computed:{threadOptions(){return this.threads.map(s=>({label:s.title,value:s.id,action:()=>this.selectThread(s.id)}))}},methods:{formattedDatetime:P,renderMarkdown(s){const t=W.parse(s);return U.sanitize(t)},goBack(){this.$router.push({name:"show-copilot-conversation-threads",params:{copilotId:this.copilotId}})},async fetchCopilot(){var s,t;try{this.isLoadingCopilot=!0;const e=await f.get(`/api/copilots/${this.copilotId}`,{params:{_relationships:"organization,users,knowledgeBases"}});this.copilot=e.data}catch(e){const n=((t=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:t.message)||(e==null?void 0:e.message)||"Failed to load Copilot";this.notificationState.showWarningNotification(n),console.error("Failed to fetch copilot:",e)}finally{this.isLoadingCopilot=!1}},async fetchThread(){var s,t;if(this.conversationThreadId)try{this.isLoadingThread=!0;const e=await f.get(`/api/conversation-threads/${this.conversationThreadId}`,{params:{_relationships:"copilot"}}),n=e.data.data||e.data;this.currentThread=n,!this.copilot&&n.copilot&&(this.copilot=n.copilot),await this.fetchMessages()}catch(e){const n=((t=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:t.message)||(e==null?void 0:e.message)||"Failed to load thread";this.notificationState.showWarningNotification(n),console.error("Failed to fetch thread:",e)}finally{this.isLoadingThread=!1}},async fetchThreads(){var s,t;if(this.copilotId)try{const e=await f.get("/api/conversation-threads",{params:{copilot_id:this.copilotId}});this.threads=e.data.data||e.data.threads||[]}catch(e){const n=((t=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:t.message)||(e==null?void 0:e.message)||"Failed to load threads";this.notificationState.showWarningNotification(n),console.error("Failed to fetch threads:",e)}},async startNewConversation(){this.$router.push({name:"create-copilot-conversation-thread",params:{copilotId:this.copilotId}})},async deleteCurrentThread(){var s,t;if(this.currentThread&&confirm("Are you sure you want to delete this thread?"))try{const e=await f.delete("/api/conversation-threads",{data:{thread_ids:[this.currentThread.id]}});e.data.deleted?(this.notificationState.showSuccessNotification(e.data.message),this.threads=this.threads.filter(n=>n.id!==this.currentThread.id),this.currentThread=null,this.messages=[],this.threads.length>0?this.selectThread(this.threads[0].id):this.goBack()):this.notificationState.showWarningNotification(e.data.message)}catch(e){const n=((t=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:t.message)||(e==null?void 0:e.message)||"Failed to delete thread";this.notificationState.showWarningNotification(n),console.error("Failed to delete thread:",e)}},async selectThread(s){this.currentThread=this.threads.find(t=>t.id===s),this.currentThread&&(this.$router.push({name:"chat-copilot-conversation-thread",params:{copilotId:this.copilotId,conversationThreadId:s}}),await this.fetchMessages())},async fetchMessages(){var s,t;if(this.currentThread)try{this.isLoadingMessages=!0;const e=await f.get("/api/conversation-messages",{params:{thread_id:this.currentThread.id}});this.messages=(e.data.data||e.data.messages||[]).reverse().map(n=>({...n,timestamp:new Date(n.timestamp||n.created_at)}))}catch(e){const n=((t=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:t.message)||(e==null?void 0:e.message)||"Failed to load messages";this.notificationState.showWarningNotification(n),console.error("Failed to fetch messages:",e)}finally{this.isLoadingMessages=!1}},async sendMessage(){var n,o;if(!this.newMessage.trim()||this.isSendingMessage||!this.copilot)return;const s={role:"user",content:this.newMessage,timestamp:new Date};this.messages.push(s),this.isSendingMessage=!0;const t={role:"thinking",timestamp:new Date};this.messages.push(t);const e=this.newMessage;this.newMessage="";try{const r=(await f.post(`/api/copilots/${this.copilotId}/query`,{query:e,conversation_thread_id:this.currentThread?this.currentThread.id:null})).data;this.messages=this.messages.filter(p=>p.role!=="thinking"),r.success?(this.messages.push({role:"assistant",content:r.response,context:r.context,timestamp:new Date}),r.thread&&!this.currentThread&&(this.currentThread=r.thread,this.threads.push(r.thread),this.$router.push({name:"chat-copilot-conversation-thread",params:{copilotId:this.copilotId,conversationThreadId:r.thread.id}}))):(this.messages.push({role:"error",content:r.message,timestamp:new Date}),r.thread&&!this.currentThread&&(this.currentThread=r.thread,this.threads.push(r.thread),this.$router.push({name:"chat-copilot-conversation-thread",params:{copilotId:this.copilotId,conversationThreadId:r.thread.id}})))}catch(i){this.messages=this.messages.filter(p=>p.role!=="thinking");const r=((o=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:o.message)||(i==null?void 0:i.message)||"Failed to get response from Copilot";this.messages.push({role:"error",content:r,timestamp:new Date}),console.error("Failed to query copilot:",i)}finally{this.isSendingMessage=!1}},toggleContext(s){this.expandedContext[s]=!this.expandedContext[s],this.$forceUpdate()}},created(){this.copilotId=this.$route.params.copilotId,this.conversationThreadId=this.$route.params.conversationThreadId,this.isNewConversation=this.$route.name==="create-copilot-conversation-thread",this.fetchCopilot(),this.conversationThreadId&&this.fetchThread(),this.fetchThreads()}},Z={class:"flex min-h-[calc(100vh-60px)] flex-col bg-gray-50 pt-8 p-4 sm:p-8 relative"},$={class:"select-none flex justify-between items-center mb-6"},ee={class:"flex items-center space-x-3"},te={class:"flex items-end space-x-2"},se={class:"flex items-center space-x-2 text-lg font-semibold"},ae={class:"flex items-center space-x-1 bg-indigo-50 px-2 py-1 border border-dashed border-indigo-200 text-indigo-500 rounded-sm text-sm"},oe={class:"flex items-center space-x-2"},ie={class:"flex-1"},ne={key:0,class:"h-80 flex items-center justify-center"},re={class:"select-none flex items-center space-x-2 py-2 px-4 rounded-full bg-indigo-500 text-white"},de={key:1,class:"select-none h-80 flex flex-col items-center justify-center text-center border border-gray-400 border-dashed rounded-lg"},ce={key:2,class:"space-y-6 pb-40"},le={key:0,class:"flex justify-end"},he={class:"max-w-2xl bg-indigo-500 text-white rounded-2xl rounded-br-none px-4 py-2"},pe=["innerHTML"],me={key:1,class:"flex justify-start items-start space-x-3"},ge={class:"max-w-2xl bg-gray-100 border border-gray-200 rounded-2xl rounded-bl-none px-4 py-2"},ue=["innerHTML"],fe={class:"text-xs text-gray-500 mt-2"},xe={key:0,class:"mt-3"},ye=["onClick"],we={key:0,class:"mt-3 space-y-3"},_e={class:"text-xs font-medium text-gray-700 flex items-center space-x-2"},ve={class:"text-gray-500"},Te={class:"text-xs text-gray-600 mt-1"},be={key:2,class:"flex justify-start items-start space-x-3"},Me={key:3,class:"flex justify-start items-start space-x-3"},ke={class:"max-w-2xl bg-red-100 text-red-700 rounded-lg p-4 shadow-sm"},Ie={class:"text-sm"},Ce={class:"text-xs text-red-500 mt-2"},Se={class:"fixed bottom-8 ml-30 w-1/2 left-1/2 transform -translate-x-1/2 bg-white border border-gray-200 rounded-2xl shadow-sm p-4"};function Le(s,t,e,n,o,i){var b,M;const r=g("Button"),p=g("BotIcon"),N=g("Dropdown"),T=g("Loader"),D=g("AlertCircle"),A=g("Input"),F=g("ArrowUp");return c(),l("div",Z,[a("div",$,[a("div",ee,[h(r,{type:"light",size:"sm",leftIcon:o.ArrowLeft,leftIconSize:"20",action:i.goBack},{default:w(()=>t[3]||(t[3]=[a("span",null,"Back",-1)])),_:1},8,["leftIcon","action"]),a("div",te,[a("div",se,[t[4]||(t[4]=a("span",null,"Chat with",-1)),a("div",ae,[h(p,{size:"20"}),a("span",null,m(((b=o.copilot)==null?void 0:b.name)||"..."),1)])])])]),a("div",oe,[h(N,{triggerSize:"sm",options:i.threadOptions,triggerText:((M=o.currentThread)==null?void 0:M.title)||"Select Thread",onSelect:i.selectThread,disabled:!1},null,8,["options","triggerText","onSelect"]),o.currentThread?(c(),l(_,{key:0},[h(r,{type:"primary",size:"sm",leftIcon:o.Plus,leftIconSize:"20",action:i.startNewConversation},{default:w(()=>t[5]||(t[5]=[a("span",null,"New Conversation",-1)])),_:1},8,["leftIcon","action"]),h(r,{type:"danger",size:"sm",leftIcon:o.Trash,leftIconSize:"20",action:i.deleteCurrentThread},{default:w(()=>t[6]||(t[6]=[a("span",null,"Delete Thread",-1)])),_:1},8,["leftIcon","action"])],64)):u("",!0)])]),a("div",ie,[o.isLoadingCopilot||o.isLoadingThread||o.isLoadingMessages?(c(),l("div",ne,[a("div",re,[h(p,{size:"32"}),h(T,{size:"20",class:"animate-spin"})])])):o.messages.length===0?(c(),l("div",de,[h(p,{size:"48",class:"text-gray-400 mb-4 animate-bounce"}),t[7]||(t[7]=a("h3",{class:"text-lg font-semibold text-gray-800"},"Start a Conversation",-1)),t[8]||(t[8]=a("p",{class:"text-sm text-gray-500 mt-2"},"Ask a question to begin chatting with Copilot",-1))])):(c(),l("div",ce,[(c(!0),l(_,null,k(o.messages,(d,x)=>(c(),l("div",{key:x,class:"space-y-2 animate-fade-in"},[d.role==="user"?(c(),l("div",le,[a("div",he,[a("p",{class:"text-sm",innerHTML:i.renderMarkdown(d.content)},null,8,pe)])])):u("",!0),d.role==="assistant"?(c(),l("div",me,[h(p,{size:"20",class:"text-gray-600 mt-2"}),a("div",ge,[a("p",{class:"text-sm text-gray-900 markdown-content",innerHTML:i.renderMarkdown(d.content)},null,8,ue),a("p",fe,m(i.formattedDatetime(d.timestamp)),1),d.context&&d.context.length>0?(c(),l("div",xe,[a("button",{onClick:y=>i.toggleContext(x),class:"text-sm text-blue-600 hover:underline focus:outline-none transition-colors duration-200"},m(o.expandedContext[x]?"Hide Sources":"Show Sources"),9,ye),o.expandedContext[x]?(c(),l("div",we,[(c(!0),l(_,null,k(d.context,(y,j)=>(c(),l("div",{key:j,class:"bg-gray-200 p-3 rounded-md shadow-inner"},[a("p",_e,[a("span",null,m(y.title),1),a("span",ve,"("+m(y.type)+")",1)]),a("p",Te,m(y.content),1)]))),128))])):u("",!0)])):u("",!0)])])):u("",!0),d.role==="thinking"?(c(),l("div",be,[h(p,{size:"20",class:"text-gray-600 mt-2"}),t[9]||(t[9]=H('<div class="max-w-2xl bg-gray-100 border border-gray-200 rounded-2xl rounded-bl-none px-4 py-2"><div class="typing-dots"><span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></div></div>',1))])):u("",!0),d.role==="error"?(c(),l("div",Me,[h(D,{size:"32",class:"text-red-500 mt-2"}),a("div",ke,[a("p",Ie,m(d.content),1),a("p",Ce,m(i.formattedDatetime(d.timestamp)),1)])])):u("",!0)]))),128))]))]),a("div",Se,[a("form",{onSubmit:t[2]||(t[2]=v((...d)=>i.sendMessage&&i.sendMessage(...d),["prevent"])),class:"flex items-start space-x-2"},[h(A,{rows:"2",type:"textarea",class:"w-full",modelValue:o.newMessage,"onUpdate:modelValue":t[0]||(t[0]=d=>o.newMessage=d),disabled:o.isSendingMessage||!o.copilot,placeholder:"Ask anything ...",onKeydown:V(v(i.sendMessage,["prevent"]),["enter"])},null,8,["modelValue","disabled","onKeydown"]),a("button",{onClick:t[1]||(t[1]=v((...d)=>i.sendMessage&&i.sendMessage(...d),["prevent"])),class:I(["select-none p-2 rounded-full",o.isSendingMessage||o.newMessage.trim()?"bg-indigo-500 transition-all hover:bg-indigo-400 hover:scale-110 hover:cursor-pointer active:scale-100":"bg-gray-100"])},[o.isSendingMessage?(c(),C(T,{key:0,size:"20",class:"text-white animate-spin"})):(c(),C(F,{key:1,size:"20",class:I([o.newMessage.trim()?"text-white":"text-gray-300"])},null,8,["class"]))],2)],32)])])}const Oe=O(Y,[["render",Le]]);export{Oe as default};
